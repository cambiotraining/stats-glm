{
  "hash": "1778e0b17a71622db55723f225319df6",
  "result": {
    "markdown": "---\ntitle: \"Generalising your model\"\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n## Putting the \"G\" into \"GLM\"\n\nIn the previous linear model example all the assumptions were met. But what if we have data where that isn't the case? For example, what if we have data where we _can't_ describe the relationship between the predictor and response variables in a linear way?\n\nOne of the ways we can deal with this is by using a **generalised linear model**, also abbreviated as GLM. In a way it's an extension of the linear model we discussed in the previous section. As with the normal linear model, the predictor variables in the model are in a linear combination, such as:\n\n$$\n\\beta_0 + \\beta_1X_1 + \\beta_2X_2 + \\beta_3X_3 + ...\n$$\n\nHere, the $\\beta_0$ value is the constant or intercept, whereas each subsequent $\\beta_i$ is a unique regression coefficient for each $X_i$ predictor variable. So far so good.\n\nHowever, the GLM makes the linear model more flexible in two ways:\n\n:::.{callout-important}\n1. In a standard linear model the linear combination (e.g. like we see above) becomes the predicted outcome value. With a GLM a transformation is specified, which turns the linear combination into the predicted outcome value. This is called a **link function**.\n2. A standard linear model assumes a continuous, normally distributed outcome, whereas **with GLM the outcome can be both continuous or integer**. Furthermore, the outcome does not have to be normally distributed. Indeed, **the outcome can follow a different kind of distribution**, such as binomial, Poisson, exponential etc.\n:::\n\nWe'll introduce each of these elements below, then illustrate how they are used in practice, using different types of data.\n\nThe link function and different distributions are closely...err, _linked_. So in order to make sense of what the link function is doing, it's useful to understand better the different distributional assumptions. So we'll start with those.\n\n## Distributions\n\nIn the examples of a linear model we've seen that the residuals needed to be normally distributed. We've mainly used the Q-Q plot to assess this assumption of normality.\n\nBut what does \"normal\" actually mean? It assumes that the residuals are coming from a normal or Gaussian distribution. This distribution has a symmetrical bell-shape, where the centre is the mean, and half of the data are on either side of this.\n\nWe can see this in @fig-normdist. The mean of the normal distribution is indicated with the dashed blue line.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![Normal distribution](glm-intro-glm_files/figure-html/fig-normdist-1.png){#fig-normdist width=672}\n:::\n:::\n\n\nWe can use the linear model we created previously, where we looked at the possible linear relationship between beak length and beak length. This is based on measurements of _G. fortis_ beaks in 1975.\n\nThe individual values of the residuals from this linear model are shown in @fig-normdist, panel B (in red), with the corresponding theoretical normal distribution in the background. We can see that the residuals follow this distribution reasonably well, which matches our conclusions from the Q-Q plot (see @fig-fortis1975_lm_dgplots).\n\nAll this means is that assuming that these residuals may come from a normal distribution isn't such a daft suggestion after all.\n\nNow look at this example:\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![Classification in beak shape](glm-intro-glm_files/figure-html/fig-beak_class-1.png){#fig-beak_class width=672}\n:::\n:::\n\n\nThe data in @fig-beak_class show the classification of beak shape for a collection of finches. They are either classed as `blunt` or `pointed`. Various (continuous) measurements were taken from each bird, with the beak depth shown here.\n\nWe'll look into this example in more detail later. For now it's important to note that the response variable (`class`) is not continuous. In this case, it's a binary response (`blunt` or `pointed`). As a result, the assumptions for a regular linear model go out of the window If we were foolish enough to fit a linear model to these data, then the residuals would look rather non-normal (@fig-beak_residuals, A).\n\nWith generalised linear models we can actually still _model_ these data as a linear relationship between the predictor (beak length) and response variable (class). But we do this through a **link function** that is able to map this linear predictor to the non-linear relationship in the data.\n\nWhen we do this and then look at the residuals, we end up with residuals that are much more normally distributed (@fig-beak_residuals, B).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Beak class model residuals](glm-intro-glm_files/figure-html/fig-beak_residuals-1.png){#fig-beak_residuals width=672}\n:::\n:::\n\n\n## Linear predictors\n\n## Link functions\n\nLet's look some data that come from an analysis of gene flow across two finch species.\n\nTwo species, _Geospiza fortis_ and _G. scandens_. There are measurements that are split by a uniquely timed event: an particularly strong El Nino event in 1983 changed the vegetation and food supply of the finches, allowing F1 hybrids to survive. These measurements are classed as `early` (pre-1983) and `late` (1983 onwards).\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\nVisualising the different groups:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Beak classification pre- and post El Nino](glm-intro-glm_files/figure-html/fig-beak_classification-1.png){#fig-beak_classification width=672}\n:::\n:::\n\n\nWe can see that in the early time point (pre-1983) both species had relatively clear beak shapes. Generally, _G. fortis_ had blunt beaks, whereas _G. scandens_ had pointed beaks.\n\nLet's say we were in a situation where we only had the beak length measurements. Could we make some predictions about the species? Let's first focus on just the early time points.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Beak classification without species information](glm-intro-glm_files/figure-html/fig-beak_classification_nospecies-1.png){#fig-beak_classification_nospecies width=672}\n:::\n:::\n\n\nWe could try to model this with the knowledge we've got so far and perform a linear regression analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(early_finches, aes(x = blength, y = pointed_beak)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](glm-intro-glm_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_early <- lm(pointed_beak ~ blength,\n               data = early_finches)\n\nanova(lm_early)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: pointed_beak\n          Df  Sum Sq Mean Sq F value    Pr(>F)    \nblength    1 12.6847 12.6847   292.2 < 2.2e-16 ***\nResiduals 59  2.5612  0.0434                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nlm_early %>% \n  resid_panel(plots = c(\"resid\", \"qq\", \"ls\", \"cookd\"),\n              smoother = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula 'y ~ x'\n`geom_smooth()` using formula 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](glm-intro-glm_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n\n```{.r .cell-code}\nlm_early %>% \n  augment() %>% \n  ggplot(aes(x = .resid)) +\n  geom_histogram()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](glm-intro-glm_files/figure-html/unnamed-chunk-19-2.png){width=672}\n:::\n:::\n\n\nAssumptions are definitely violated. Surprisingly, the Q-Q plot and histogram of the residuals doesn't look too bad.\n\nBut we can't describe these data with some kind of linear relationship, of course.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglm_early <- glm(pointed_beak ~ blength,\n                 family = binomial(link = \"logit\"),\n                 data = early_finches)\n\nsummary(glm_early)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = pointed_beak ~ blength, family = binomial(link = \"logit\"), \n    data = early_finches)\n\nDeviance Residuals: \n     Min        1Q    Median        3Q       Max  \n-1.16571  -0.06960   0.00647   0.04931   2.28475  \n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)   \n(Intercept)  -43.410     15.250  -2.847  0.00442 **\nblength        3.387      1.193   2.839  0.00452 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 84.5476  on 60  degrees of freedom\nResidual deviance:  9.1879  on 59  degrees of freedom\nAIC: 13.188\n\nNumber of Fisher Scoring iterations: 8\n```\n:::\n:::\n\n\nLet's plot the fitted model values:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglm_early %>% \n  augment() %>% \n  ggplot(aes(x = blength, y = .fitted)) +\n  geom_point(colour = \"blue\")\n```\n\n::: {.cell-output-display}\n![](glm-intro-glm_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\nMain points:\n\n* `blength` is a significant predictor of `pointed_beak`\n* the fitted model values are still linear!\n\nThe fitted model values are linear because the non-linear relationship between beak length and beak type is linearised by the model. It does so using a **link function**.\n\nIn this case the default link function for the binomial family of models is the **logit** function.\n\nSo the values we're seeing are on a logit scale. If we wanted to visualise the actual _probabilities_, we could do that as follows (also displaying the model predictions as a dashed line for clarity):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglm_early %>% \n  augment(type.predict = \"response\") %>% \n  ggplot() +\n  geom_point(aes(x = blength, y = pointed_beak)) +\n  geom_line(aes(x = blength, y = .fitted),\n            linetype = \"dashed\",\n            colour = \"blue\") +\n  geom_point(aes(x = blength, y = .fitted),\n             colour = \"blue\", alpha = 0.4) +\n  labs(title = \"Logistic model predictions for pointed beaks\",\n       x = \"beak length (mm)\",\n       y = \"Probability\")\n```\n\n::: {.cell-output-display}\n![](glm-intro-glm_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\nFrom this we can see that the probability of having a pointed beak (which is considered a \"success\") is approaching 1 as the beak length gets longer.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(modelr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'modelr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:yardstick':\n\n    mae, mape, rmse\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:broom':\n\n    bootstrap\n```\n:::\n\n```{.r .cell-code}\nblength <- data.frame(blength = c(8.2, 9.4, 11.6, 12.8, 13.9, 15.7))\n\nadd_predictions(blength, glm_early,\n                type = \"response\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  blength         pred\n1     8.2 1.613509e-07\n2     9.4 9.390524e-06\n3    11.6 1.590097e-02\n4    12.8 4.846392e-01\n5    13.9 9.750049e-01\n6    15.7 9.999423e-01\n```\n:::\n:::\n",
    "supporting": [
      "glm-intro-glm_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}